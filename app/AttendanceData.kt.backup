package com.example.splash

import android.content.Context
import androidx.core.content.edit
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

data class AttendanceRecord(
    val id: String,
    val type: AttendanceType,
    val date: String,
    val time: String,
    val location: String,
    val timestamp: Long
) {
    fun toJsonString(): String {
        return "$id|${type.name}|$date|$time|$location|$timestamp"
    }
    
    companion object {
        fun fromJsonString(json: String): AttendanceRecord? {
            return try {
                val parts = json.split("|")
                if (parts.size == 6) {
                    AttendanceRecord(
                        id = parts[0],
                        type = AttendanceType.valueOf(parts[1]),
                        date = parts[2],
                        time = parts[3],
                        location = parts[4],
                        timestamp = parts[5].toLong()
                    )
                } else null
            } catch (@Suppress("UNUSED_PARAMETER") e: Exception) {

                null
            }
        }
    }
}

enum class AttendanceType {
    CHECK_IN,
    CHECK_OUT
}

object AttendanceStorage {
    private const val PREFS_NAME = "attendance_prefs"
    private const val KEY_ATTENDANCE_LIST = "attendance_list"
    
    fun saveAttendance(context: Context, record: AttendanceRecord) {
        val prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
        val existing = getAttendanceHistory(context).toMutableList()
        existing.add(record)

        val toSave = if (existing.size > 100) existing.takeLast(100) else existing
        val jsonList = toSave.joinToString(";;") { it.toJsonString() }
        prefs.edit {
            putString(KEY_ATTENDANCE_LIST, jsonList)
        }
    }
    
    fun getAttendanceHistory(context: Context): List<AttendanceRecord> {
        val prefs = context.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE)
        val jsonList = prefs.getString(KEY_ATTENDANCE_LIST, "") ?: ""
        if (jsonList.isEmpty()) return emptyList()
        
        return jsonList.split(";;")
            .mapNotNull { AttendanceRecord.fromJsonString(it) }
            .sortedByDescending { it.timestamp }
    }
    
    @Suppress("UNUSED")
    fun getTodayAttendance(context: Context): List<AttendanceRecord> {
        val today = SimpleDateFormat("dd MMMM yyyy", Locale.forLanguageTag("id-ID")).format(Date())
        return getAttendanceHistory(context).filter { it.date == today }
    }
    
    @Suppress("UNUSED")
    fun getLastCheckIn(context: Context): AttendanceRecord? {
        return getAttendanceHistory(context).firstOrNull { it.type == AttendanceType.CHECK_IN }
    }
    
    @Suppress("UNUSED")
    fun canCheckOut(context: Context): Boolean {
        val today = SimpleDateFormat("dd MMMM yyyy", Locale.forLanguageTag("id-ID")).format(Date())
        val todayCheckIn = getAttendanceHistory(context)
            .firstOrNull { it.date == today && it.type == AttendanceType.CHECK_IN }
        val todayCheckOut = getAttendanceHistory(context)
            .firstOrNull { it.date == today && it.type == AttendanceType.CHECK_OUT }
        
        return todayCheckIn != null && todayCheckOut == null
    }
}

